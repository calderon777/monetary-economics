---
title: "Monetary Economics - Week 1 Lecture"
author: "By Dr Camilo Calderon"
format:
  revealjs:
    theme: default
    slide-number: true
    chalkboard: true
    preview-links: auto
execute:
  echo: false
  warning: false
  message: false
---

```{r setup}
#| include: false

# Configuration - CHANGE THIS FOR EACH LECTURE
ppt_filename <- "week1lecture2.pptx"
ppt_path <- file.path("ppt", ppt_filename)
img_dir  <- file.path("ppt", "slides_png")

# Create output directory
dir.create(img_dir, recursive = TRUE, showWarnings = FALSE)
```

```{r export-pptx-to-png}
#| include: false
#| eval: true

# Windows + PowerPoint only
if (.Platform$OS.type != "windows") {
  stop("PowerPoint export requires Windows.")
}

if (!file.exists(ppt_path)) {
  stop(paste("PPTX not found:", ppt_path))
}

# Clear old PNGs to avoid confusion
old <- list.files(img_dir, pattern = r"(\.(png|PNG)$)", full.names = TRUE)
if (length(old)) {
  file.remove(old)
}

# Get absolute paths
in_abs <- normalizePath(ppt_path, mustWork = TRUE)
out_abs <- normalizePath(img_dir, mustWork = TRUE)

# Create PowerShell script file
ps_file <- file.path(tempdir(), "export_pptx.ps1")

ps_code <- sprintf('
$in = "%s"
$out = "%s"

New-Item -ItemType Directory -Force -Path $out | Out-Null

$ppt = New-Object -ComObject PowerPoint.Application
$ppt.Visible = [Microsoft.Office.Core.MsoTriState]::msoTrue

$pres = $ppt.Presentations.Open($in, [Microsoft.Office.Core.MsoTriState]::msoFalse, [Microsoft.Office.Core.MsoTriState]::msoFalse, [Microsoft.Office.Core.MsoTriState]::msoTrue)

# 18 = ppSaveAsPNG format
$pres.SaveAs($out, 18)

$pres.Close()
$ppt.Quit()

[System.Runtime.InteropServices.Marshal]::ReleaseComObject($pres) | Out-Null
[System.Runtime.InteropServices.Marshal]::ReleaseComObject($ppt) | Out-Null
[GC]::Collect()
[GC]::WaitForPendingFinalizers()

Write-Host "Export complete"
', in_abs, out_abs)

writeLines(ps_code, ps_file)

# Run PowerShell script file
result <- system2("powershell", 
                  args = c("-NoProfile", "-ExecutionPolicy", "Bypass", "-File", ps_file),
                  stdout = TRUE, stderr = TRUE)

# Clean up temp file
file.remove(ps_file)

# Verify output
pngs <- list.files(img_dir, pattern = r"(^Slide\d+\.(png|PNG)$)", full.names = TRUE)

if (length(pngs) == 0) {
  stop(paste(
    "PowerPoint produced no PNGs.\n",
    "Input:", in_abs, "\n",
    "Output:", out_abs, "\n",
    "Error:\n",
    paste(result, collapse = "\n")
  ))
}
```

```{r render-png-slides}
#| output: asis
#| eval: true

# Get all Slide*.PNG files (PowerPoint naming convention)
imgs <- list.files(img_dir, pattern = r"(^Slide\d+\.(png|PNG)$)", full.names = TRUE)

# Sort by slide number
get_slide_number <- function(x) {
  as.numeric(gsub(r"(^Slide(\d+)\.(png|PNG)$)", "\\1", basename(x), ignore.case = TRUE))
}
imgs <- imgs[order(sapply(imgs, get_slide_number))]

# Render each PNG as a Reveal.js slide background
for (img in imgs) {
  rel <- gsub("\\\\", "/", img)
  cat("\n---\n\n")
  cat(sprintf('## {background-image="%s" background-size="contain" background-position="center"}\n\n', rel))
}
```

<!-- 
INSTRUCTOR NOTES:
- Converts PPTX â†’ PNG using PowerPoint COM automation
- Each slide becomes a full-resolution Reveal.js background slide
- Students see only the slides, not the conversion process
- To update for a different lecture, change ppt_filename on line 16
- For 300 DPI quality, run once in PowerShell:
  New-ItemProperty -Path "HKCU:\Software\Microsoft\Office\16.0\PowerPoint\Options" -Name "ExportBitmapResolution" -PropertyType DWord -Value 300 -Force | Out-Null
-->
