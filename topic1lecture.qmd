---
title: "Lecture 1 - The Nature and Economic Role of Money"
author: "Adapted by Dr Camilo Calderon"
format:
  revealjs:
    theme: default
    slide-number: true
    chalkboard: true
    preview-links: auto
execute:
  echo: false
  warning: false
  message: false
---

```{r setup}
#| include: false

# Configuration - CHANGE THIS FOR EACH LECTURE
ppt_filename <- "topic1lecture.pptx"

# Auto-generate folder name from this .qmd file name
qmd_name <- knitr::current_input(dir = FALSE)
qmd_base <- tools::file_path_sans_ext(qmd_name)  # e.g., "week1lecture"

# Paths
ppt_path <- file.path("ppt", ppt_filename)
img_dir  <- file.path("ppt", paste0(qmd_base, "_png"))  # e.g., "ppt/week1lecture_png"

# Create output directory
dir.create(img_dir, recursive = TRUE, showWarnings = FALSE)
```

```{r export-pptx-to-png}
#| include: false
#| eval: true

# Windows + PowerPoint only
if (.Platform$OS.type != "windows") {
  stop("PowerPoint export requires Windows.")
}

if (!file.exists(ppt_path)) {
  stop(paste("PPTX not found:", ppt_path))
}

# Clear old PNGs to avoid confusion (only in this lecture's folder)
old <- list.files(img_dir, pattern = r"(\.(png|PNG)$)", full.names = TRUE)
if (length(old)) {
  file.remove(old)
}

# Get absolute paths
in_abs <- normalizePath(ppt_path, mustWork = TRUE)
out_abs <- normalizePath(img_dir, mustWork = TRUE)

# Create PowerShell script file
ps_file <- file.path(tempdir(), "export_pptx.ps1")

ps_code <- sprintf('
$in = "%s"
$out = "%s"

New-Item -ItemType Directory -Force -Path $out | Out-Null

$ppt = New-Object -ComObject PowerPoint.Application
$ppt.Visible = [Microsoft.Office.Core.MsoTriState]::msoTrue

$pres = $ppt.Presentations.Open($in, [Microsoft.Office.Core.MsoTriState]::msoFalse, [Microsoft.Office.Core.MsoTriState]::msoFalse, [Microsoft.Office.Core.MsoTriState]::msoTrue)

# 18 = ppSaveAsPNG format
$pres.SaveAs($out, 18)

$pres.Close()
$ppt.Quit()

[System.Runtime.InteropServices.Marshal]::ReleaseComObject($pres) | Out-Null
[System.Runtime.InteropServices.Marshal]::ReleaseComObject($ppt) | Out-Null
[GC]::Collect()
[GC]::WaitForPendingFinalizers()

Write-Host "Export complete"
', in_abs, out_abs)

writeLines(ps_code, ps_file)

# Run PowerShell script file
result <- system2("powershell", 
                  args = c("-NoProfile", "-ExecutionPolicy", "Bypass", "-File", ps_file),
                  stdout = TRUE, stderr = TRUE)

# Clean up temp file
file.remove(ps_file)

# Verify output
pngs <- list.files(img_dir, pattern = r"(^Slide\d+\.(png|PNG)$)", full.names = TRUE)

if (length(pngs) == 0) {
  stop(paste(
    "PowerPoint produced no PNGs.\n",
    "Input:", in_abs, "\n",
    "Output:", out_abs, "\n",
    "Error:\n",
    paste(result, collapse = "\n")
  ))
}
```

```{r export-pptx-to-pdf}
#| include: false
#| eval: true

# Export PPTX to PDF for download
pdf_filename <- paste0(tools::file_path_sans_ext(ppt_filename), ".pdf")
pdf_path <- file.path("ppt", pdf_filename)
pdf_abs <- normalizePath(dirname(pdf_path), mustWork = TRUE)
pdf_full <- file.path(pdf_abs, pdf_filename)

# Create PowerShell script for PDF export
ps_pdf_file <- file.path(tempdir(), "export_pdf.ps1")

ps_pdf_code <- sprintf('
$in = "%s"
$out = "%s"

$ppt = New-Object -ComObject PowerPoint.Application
$ppt.Visible = [Microsoft.Office.Core.MsoTriState]::msoFalse

$pres = $ppt.Presentations.Open($in, [Microsoft.Office.Core.MsoTriState]::msoFalse, [Microsoft.Office.Core.MsoTriState]::msoFalse, [Microsoft.Office.Core.MsoTriState]::msoFalse)

# 32 = ppSaveAsPDF format
$pres.SaveAs($out, 32)

$pres.Close()
$ppt.Quit()

[System.Runtime.InteropServices.Marshal]::ReleaseComObject($pres) | Out-Null
[System.Runtime.InteropServices.Marshal]::ReleaseComObject($ppt) | Out-Null
[GC]::Collect()
[GC]::WaitForPendingFinalizers()

Write-Host "PDF export complete"
', in_abs, pdf_full)

writeLines(ps_pdf_code, ps_pdf_file)

# Run PowerShell script
result_pdf <- system2("powershell", 
                      args = c("-NoProfile", "-ExecutionPolicy", "Bypass", "-File", ps_pdf_file),
                      stdout = TRUE, stderr = TRUE)

# Clean up
file.remove(ps_pdf_file)

# Verify PDF was created
if (!file.exists(pdf_path)) {
  warning(paste("PDF export may have failed:", paste(result_pdf, collapse = "\n")))
}
```

```{r render-png-slides}
#| output: asis
#| eval: true

# Get all Slide*.PNG files (PowerPoint naming convention)
imgs <- list.files(img_dir, pattern = r"(^Slide\d+\.(png|PNG)$)", full.names = TRUE)

# Sort by slide number
get_slide_number <- function(x) {
  as.numeric(gsub(r"(^Slide(\d+)\.(png|PNG)$)", "\\1", basename(x), ignore.case = TRUE))
}
imgs <- imgs[order(sapply(imgs, get_slide_number))]

# Render each PNG as a Reveal.js slide background
for (i in seq_along(imgs)) {
  img <- imgs[i]
  rel <- gsub("\\\\", "/", img)
  cat("\n---\n\n")
  cat(sprintf('## {background-image="%s" background-size="contain" background-position="center"}\n\n', rel))
  
  # Add PDF download button on first slide
  if (i == 1) {
    pdf_rel <- gsub("\\\\", "/", file.path("ppt", paste0(tools::file_path_sans_ext(ppt_filename), ".pdf")))
    cat(sprintf('\n<div style="position: absolute; top: 20px; right: 20px; z-index: 100;">\n'))
    cat(sprintf('  <a href="%s" download style="text-decoration: none; font-size: 2em; color: #e74c3c; background: white; padding: 10px 15px; border-radius: 50%%; box-shadow: 0 2px 5px rgba(0,0,0,0.3);" title="Download PDF">ðŸ“„</a>\n', pdf_rel))
    cat('</div>\n\n')
  }
}
```

<!-- 
===========================================
TEMPLATE FOR ALL LECTURES
===========================================

USAGE:
1. Copy this file (e.g., week2lecture.qmd, week3lecture.qmd)
2. Update YAML title and author
3. Change ppt_filename on line 17
4. Render (Ctrl+Shift+K or quarto render)

FOLDER STRUCTURE:
- week1lecture.qmd â†’ ppt/week1lecture_png/Slide1.PNG, Slide2.PNG, ...
- week2lecture.qmd â†’ ppt/week2lecture_png/Slide1.PNG, Slide2.PNG, ...
- week3lecture.qmd â†’ ppt/week3lecture_png/Slide1.PNG, Slide3.PNG, ...

Each lecture's PNGs are isolated in their own folder.

ONE-TIME SETUP FOR HIGH-QUALITY PNGS (300 DPI):
Run once in PowerShell:

New-Item -Path "HKCU:\Software\Microsoft\Office\16.0\PowerPoint\Options" -Force | Out-Null
New-ItemProperty -Path "HKCU:\Software\Microsoft\Office\16.0\PowerPoint\Options" `
  -Name "ExportBitmapResolution" -PropertyType DWord -Value 300 -Force | Out-Null

Then close PowerPoint and re-render.

===========================================
-->
